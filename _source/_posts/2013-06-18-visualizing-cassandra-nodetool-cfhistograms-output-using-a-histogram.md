---
layout: post
title: Visualizing Cassandra nodetool cfhistograms output using a histogram
published: true
tags:
  - cassandra
  - open source
  - histograms
---

## [{{page.title}}][1]

[Apache Cassandra][2] includes a lot of functionality and tools which provide
good visibility into your cluster health and performance.

A lot of this performance and health related is exposed over the
[JMX interface][4] and through the [nodetool][5] command line tool. nodetool is
a simple wrapper around JMX interface which allows you to access some of the
most commonly used attributes through a simple command line interface.

Another feature which was added recently and is available in Cassandra 1.2 is a
feature called [request tracing][3]. Request tracing allows you see exactly
what is happens during a query executing and exactly how long each step takes.

<div class="imginline"><a
href="/images/2013-06-18-visualizing-cassandra-nodetool-cfhistograms-output-using-a-histogram/request_tracing.png"
class="fancybox" title="Example of the request tracing session output. Source:
http://www.datastax.com/dev/blog/tracing-in-cassandra-1-2"><img
src="/images/2013-06-18-visualizing-cassandra-nodetool-cfhistograms-output-using-a-histogram/request_tracing_thumb.png"
class="inline"></a><span class="image-caption">Example of the request tracing session output.</span></div>

This data is very granular and includes everything from how much time it takes
to parse the CQL query to how much time it takes to talk to other nodes in the
cluster and read data from memory and / or disk.

This functionality is very powerful, but it's only available in Cassandra 1.2.

Some of the Cassandra clusters we operate here at Rackspace, more specifically
on the [Cloud Monitoring team][6], don't run Cassandra 1.2 yet. Because of that,
I'm going to focus on another very useful feature which is available in the older
versions of Cassandra today.

This feature is `cfhistograms` command exposed by the `nodetool` utility.

### cfhistograms nodetool command

[cfhistograms][7] command prints statistic [histograms][11] for a particular
column family. The output includes the following information:

* Distribution of the write latency
* Distribution of the read latency
* Distribution of number of [sstables][12] accessed during a read
* Distribution of the row size
* Distribution of number of columns in a row

<div class="imginline"><a
href="/images/2013-06-18-visualizing-cassandra-nodetool-cfhistograms-output-using-a-histogram/cf_histograms_output.png"
class="fancybox" title="nodetool cfhistograms command output. Useful but hard to interpret."><img
src="/images/2013-06-18-visualizing-cassandra-nodetool-cfhistograms-output-using-a-histogram/cf_histograms_output_thumb.png"
class="inline"></a><span class="image-caption">nodetool cfhistograms command output. Useful but hard to interpret.</span></div>

This information is very useful, but the problem is that the default output is
very convoluted and hard to read. If you Google around, you can find some good
posts which explain how to interpret this output (e.g.
[Cassandra 0.7.x - Understanding the output of nodetool cfhistograms][8]), but
nevertheless interpreting the raw command line output is still time consuming
and cumbersome.

### Visualizing cfhistograms output using a histogram

Around a year ago I was debugging a performance issues in one of our
clusters so I decided to write simple Python script which visualizes the
`cfhistograms` output using a histogram.

This script is nothing fancy, but it does it's job. In the background it uses
a couple of lines of Python and [matplotlib][9] to convert the raw text output
into nice looking histograms.

<div class="imginline"><a
href="/images/2013-06-18-visualizing-cassandra-nodetool-cfhistograms-output-using-a-histogram/sstables_histogram.png"
class="fancybox" title="Histogram generated by the script. It makes identifying the outliers just by glancing over the image a lot
easier and faster."><img
src="/images/2013-06-18-visualizing-cassandra-nodetool-cfhistograms-output-using-a-histogram/sstables_histogram_thumb.png"
class="inline"></a><span class="image-caption">Histogram generated by the script. It makes identifying the outliers just by glancing over the image a lot
easier and faster.</span></div>

#### Usage

Script is available as a [gist on Github][10].

##### 1. Download and chmod the script

{% highlight bash %}
wget "https://gist.github.com/Kami/5810229/raw/189ab7232bcb6db5dd5f6871533bcb5efecdfd84/cassandra_cfhistograms_to_histogram.py"
chmod +x cassandra_cfhistograms_to_histogram.py
{% endhighlight %}

##### 2. Install the matplotlib dependency

{% highlight bash %}
pip install matplotlib
{% endhighlight %}

##### 3. Run the script

{% highlight bash %}
./cassandra_cfstats_histogram.py --input=<path to the file with cfhistograms output> \
                                 --output=<directory where the histograms will be saved>
{% endhighlight %}

For example:

{% highlight bash %}
./cassandra_cfstats_histogram.py --input=/home/myuser/cfhistograms_output.txt \
                                 --output=/home/myuser/histograms-images/
{% endhighlight %}

All this script does it reads data from the input file, processes it and
writes 5 different histogram files to the output directory.

### Conclusion

I hope you find it useful and this script will allow you to more easily
interpret the output of nodetool `cfhistograms` command.

In the future I will try to write more about how we used the output of this
command in practice to identify and issue and misconfiguration in one of our
clusters.

[1]: {{ page.url }}
[2]: https://cassandra.apache.org/
[3]: http://www.datastax.com/dev/blog/tracing-in-cassandra-1-2
[4]: https://wiki.apache.org/cassandra/JmxInterface
[5]: https://wiki.apache.org/cassandra/NodeTool
[6]: http://www.rackspace.com/cloud/monitoring/
[7]: http://www.datastax.com/docs/1.2/references/nodetool#nodetool-cfhistograms
[8]: http://narendrasharma.blogspot.com/2011/04/cassandra-07x-understanding-output-of.html
[9]: http://matplotlib.org/
[10]: https://gist.github.com/Kami/5810229
[11]: https://en.wikipedia.org/wiki/Histogram
[12]: https://wiki.apache.org/cassandra/ArchitectureSSTable
